<?php namespace Avalara;
/*
 * AvaTax API Client Library
 *
 * (c) 2004-2016 Avalara, Inc.
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
namespace Avalara.AvaTax;

use Guzzle\Http\Client;

/**
 * @@author Ted Spence <ted.spence@@avalara.com>
 * @@author Bob Maidens <bob.maidens@@avalara.com>
 */
class AvaTaxClient 
{

@foreach(var m in SwaggerModel.Methods) {
    var paramlist = new System.Text.StringBuilder();
    var guzzleparamlist = new System.Text.StringBuilder();
    var paramcomments = new System.Collections.Generic.List<string>();
    string payload = "null";
    foreach (var p in m.Params) {
        paramlist.Append("$");
        paramlist.Append(p.CleanParamName);
        paramlist.Append(", ");
    }
    foreach (var p in m.QueryParams) {
        paramlist.Append("$");
        paramlist.Append(p.CleanParamName);
        paramlist.Append(", ");
        guzzleparamlist.Append("'" + p.ParamName + "' = $" + p.CleanParamName + ", ");
        paramcomments.Add("\r\n     * @param " + p.TypeName + " $" + p.CleanParamName + " " + p.Comment.Replace("\r\n", " "));
    }
    if (m.BodyParam != null) {
        paramlist.Append("$");
        paramlist.Append(m.BodyParam.CleanParamName);
        paramlist.Append(", ");
        payload = "$" + m.BodyParam.CleanParamName;
        paramcomments.Add("\r\n     * @param " + m.BodyParam.TypeName + " $" + m.BodyParam.CleanParamName + " " + m.BodyParam.Comment.Replace("\r\n", " "));
    }
    if (paramlist.Length > 0) paramlist.Length -= 2;
    if (guzzleparamlist.Length > 0) guzzleparamlist.Length -= 2;

<text>
    /**
     * @m.Comment
     * </text>@foreach (var pc in paramcomments) { Write(pc);}<text>
     * @@return @m.TypeName
     */
    public function @{Write(FirstCharLower(m.Name) + "(" + paramlist.ToString() + ")");}
    {
        $path = "@m.URI.Replace("{", "{$")";
        $guzzleparams = [
            'query' => [@guzzleparamlist.ToString()],
            'body' => @payload
        ];
        return $this->restcall($path, '@m.HttpVerb.ToUpper()', $guzzleparams);
    }
</text>}

    private $client;

    /**
     * Construct a new AvaTaxClient 
     * @@param string $environment Indicates which server to use; acceptable values are "sandbox" or "production"
     */
    public function __construct($environment)
    {
        // Configure the HTTP client
        $this->client = new Client();
        if ($environment == "sandbox") {
            $this->client->setBaseUri('https://sandbox-rest.avatax.com');
        } else {
            $this->client->setBaseUri('https://rest.avatax.com');
        }
        $this->client->setDefaultOption('headers', array('Accept' => 'application/json'));
    }

    private function restcall($apiUrl, $method, $payload, $guzzleparams)
    {
        $timestamp = time();
        $url .= "&ts=" . $timestamp . "&apikey=" . $apiKey . "&hash=" . $hash;

        try {
            $response = $this->client->request($method, $apiUrl, $guzzleparams);
            $body = $response->getBody();
            return json_decode($body);

        } catch (\Exception $e) {
            return $e->getMessage();
        }
    }
}
